---
layout: post
title: HTTP权威指南
tags: 读书笔记
---

## 前言

HTTP（Hypertext Transfer Protocol，超文本传输协议，Transfer表示“[状态的]转移”）是在万维网上进行通信时所使用的协议方案。HTTP有很多应用，最著名的应用是Web浏览器和Web服务器之间的双工通信。

本书不仅仅是一本HTTP首部参考手册，而是一本名副其实的Web架构“圣经”。

本书是为所有希望理解HTTP和Web底层结构的人编写的。软硬件工程师也可以将本书作为HTTP及相关Web技术参考书使用。系统架构师和网络管理员可以通过本书更好地了解如何设计、实现并管理复杂的网络架构。性能工程师和分析人员可以从缓存和性能优化的相关章节中获益。市场营销和咨询专家还可以通过概念介绍更好的理解Web技术的前景。

## 第一部分 HTTP：Web的基础

### 第一章 HTTP概述

Web 浏览器、服务器和相关的 Web 应用程序都是通过HTTP相互通信的。HTTP 是现代全球因特网中使用的公共语言。

#### 1.1 HTTP——因特网的多媒体信使

HTTP使用 的是可靠的数据传输协议，从遍布全世界的Web服务器上将这些多媒体信息块迅速、便捷、可靠地搬移到人们桌面上的Web浏览器上去。即使数据来自地球的另一端，它也能够确保数据在传输的过程中不会被损坏或产生混乱。

#### 1.2 Web客户端和服务器

客户端向服务器发送请求，服务器会在HTTP响应中回送所请求的数据。HTTP客户端和HTTP服务器共同构成了万维网的基本组件。

#### 1.3 资源

Web 服务器是 Web 资源 (Web resource)的宿主。Web资源是Web内容的源头。所有能够提供Web内容的东西都是Web资源。

##### 1.3.1 媒体类型

最初设计MIME(Multipurpose Internet Mail Extension，多用途因特网邮件扩展)是为了解决在不同的电子邮件系统之间搬移报文时存在的问题。MIME类型是一种文本标记，表示一种主要的对象类型和一个特定的子类型、中间由一条斜杠来分隔。

1. HTML格式的文本文档由text/html类型来标记。
2. 普通的ASCII文本文档由text/plain类型来标记。
3. JPEG格式的图片为image/ipeg类型。
4. GIF格式的图片为image/gif类型。
5. Apple的QuickTime电影为video/quicktime 类型。
6. 微软的Powerpoint演示文件为application/vnd. ms-powerpoint类型。

Web服务器会为所有HTTP对象数据附加一个MIME类型。当Web浏览器从服务器中取回一个对象时，会去查看相关的MIME类型，看看它是否知道以及应该如何处理这个对象。

##### 1.3.2 URI

服务器资源名被称为统一资源标识符(Uniform Resource Identifier,URI)，在世界范围内唯一标识并定位信息资源。URI有两种形式，分别称为URL和URN。

##### 1.3.3 URL

统一资源定位符(URL)是资源标识符最常见的形式。URL描述了一台特定服务器上某资源的特定位置。大部分URL都遵循标准格式，该格式包含三个部分：

1. URL的第一部分被称为方案(scheme)，说明了访问资源所使用的协议类型。这部分通常
就是HTTP协议(http：//)。
2. 第二部分给出了服务器的因特网地址。
3. 其余部分指定了Web服务器上的某个资源。

##### 1.3.4 URN

URN是作为特定内容的唯一名称使用的，与目前的资源所在地无关。通过URN，可以用同一个名字通过多种网络访问协议来访问资源。

URN形式如下：

urn:ietf:rfc:2141

URN仍然处于试验阶段，还未大范围使用。为了更有效地工作，URN需要一个支撑架构来解析资源的位置。

#### 1.4 事务

每条HTTP事务由一条从客户端发往服务器的请求命令和一个从服务器发回客户端的响应结果组成。这种通信是通过名为HTTP 报文 (HTTP message) 的格式化数据块进行。

##### 1.4.1 方法

每条HTTP请求报文都包含一个方法，告诉服务器要执行什么动作(获取一个Web页面、运行一个网关程序、删除一个文件等)。五种常见的HTTP方法如下：

| HTTP方法 | 描述 ｜
|:----------:|-------|
| GET | 从服务器向客户端发送命名资源 |
| PUT | 将来自客户端的数据存储到一个命名的服务器资源中去 |
| DELETE |从服务器中删除命名资源 |
| POST | 将客户端数据发送到一个服务器网关应用程序 |
| HEAD | 仅发送命名资源响应中的HTTP首部 |

##### 1.4.2 状态码

每条HTTP响应报文返回时都会携带一个状态码。伴随着每个数字状态码，HTTP还会发送一条解释性的“原因短语”文本进行描述，所有的处理过程使用的都是数字码。状态码是一个三位数字的代码，告知客户端请求是否成功，或者是否需受采取其他动作。几种常见的状态码如下：

| HTTP状态码 ｜ 描述 ｜
|:-------------:|-------|
| 200 | OK。文档正确返回 ｜
| 302 | Redirect(重定向)。到其他地方去获取资源 |
| 404 | Not Found(没找到)。无法找到这个资源 |

##### 1.4.3 Web页面中可以包含多个对象

应用程序完成一项任务时通常会发布多个HTTP事务。比如，Web浏览器会首先执行一个事务来获取描述页面布局的HTML“框架”，然后发布另
外的HTTP事务来获取每个嵌入式图片、图像面板、Java小程序等。

#### 1.5 报文

HTTP报文是由一行一行的简单字符串组成的。HTTP报文都是纯文本，不是二进制代码，所以人们可以很方便地对其进行读写。

从Web客户端发往Web服务器的HTTP 报文称为请求报文 ( request message)。从服务器发往客户端的报文称为响应报文(response message)。此外没有其他类型的HTTP报文。

HTTP请求和响应报文的格式很类似。HTTP报文包括以下三个部分。

1. 起始行

    报文的第一行就是起始行，在请求报文中用来说明要做些什么，在响应报文中说明出现了什么情况。

2. 首部字段

    起始行后面有零个或多个首部字段。每个首部字段都包含一个名字和一个值，两者之间用冒号(:)来分隔。首部以一个空行结束。

3. 主体

    空行之后就是可选的报文主体，其中包含了所有类型的数据。请求主体中包括了要发送给Web服务器的数据；响应主体中装载了所有要返回客户端的数据。

起始行和首部都是文本而且都是结构化的，而主体则不同，主体中可以包含任意的二进制数据(比如图片、视频、音轨、软件程序)。当然，主体中也可以包含文本。

#### 1.6 连接

##### 1.6.1 TCP/IP

HTTP是个应用层协议。HTTP无需关心网络通信的具体细节；联网的细节都交给了通用、可靠的因特网传输协议TCP/IP.

传输控制协议(Transmission Control Protocol,TCP)提供了：

1. 无差错的数据传输

2. 按序传输(数据总是会按照发送
的顺序到达)

3. 未分段的数据流(可以在任意时
刻以任意尺寸将数据发送出去)。

因特网自身就是基于TCP/IP的，TCP/IP是全世界地计算机和网络设备常用的层次化分组交换网络协议集。TCP/IP隐藏了各种网络和硬件的特点
及弱点，使各种类型的计算机和网络都能够进行可靠地通信。只要建立T TCP连接，客户端和服务器之间的报文交换就不会丢失、不会被破坏，也不会在接收时出现错序了。

用网络术语来说，HTTP协议（应用层）位于TCP（传输层）的上层。HTTP使用TCP来传输其报文数据。与之类似，TCP则位于IP（网络层）的上层，网络特有的链路接口（数据链路层）和物理网络硬件（物理层）依次在下面，共同构成了HTTP协议栈。

![HTTP网络协议栈](/book/media/http-the-definitive-guide-1-9.png)

##### 1.6.2 连接、IP地址及端口号

在HTTP客户端向服务器发送报文之前。需要用网际协议（Internet Protocol，IP）地址和端口号在客户端和服务器之间建立一条TCP/IP连接。

在TCP中，你需要知道服务器的IP地址。以及与服务器上运行的特定软件相关的TCP端口号。

![基本的浏览器连接处理](/book/media/http-the-definitive-guide-1-10.png)

##### 1.6.3 一个使用Telnet的实例

Telnet程序可以将键盘连接到某个目标 TCP端口，并将此 TCP端口的输出回送到显示屏上。Telnet常用于远程终端会话，但它几乎可以连接所有的 TCP服务器，包括 HTTP服务器。

Telnet可以打开一条到某台机器上某个端口的 TCP连接，然后直接向那个端口输入一些字符。由一个空行表示输入结束。

通过nc（netcat）可以很方便地操纵基于 UDP和 TCP的流量（包括HTTP），还可以为其编写脚本。

#### 1.7 协议版本

#### 1.8 Web的结构组件

#### 1.9 起始部分的结束语

#### 1.10 更多信息

### 第二章 URL与资源

## 第二部分 HTTP结构

### 第6章 代理

Web代理（proxy）服务器是网络的中间实体。代理位于客户端和服务器之间，扮演“中间人”的角色，在各端点之间来回传送HTTP报文。

#### 6.1 Web的中间实体

Web上的代理是代表客户端完成事务处理的中间人，客户端通过代理服务器来完成对事务的处理。

HTTP的代理既是Web服务器又是Web客户端。HTTP客户端会向代理发送请求报文，代理服务器必须像Web服务器一样，正确的处理请求和连接，然后返回响应。同时，代理自身要向服务器发送请求，此时就必须像正确的HTTP客户端一样，要发送请求并接收响应。HTTP代理必须同时遵循为HTTP客户端和HTTP服务器定制的规则。

![代理既是服务器，又是客户端](/book/media/http-the-definitive-guide-6-1.png)

##### 6.1.1 公共和私有代理

代理根据是否为单个客户端所专用而分为公共代理和私有代理两类。公共代理比较常见，比如高速缓存代理服务器会复用用户间的共同请求。

##### 6.1.2 代理和网关的对比

严格来说，代理连接的是两个或多个使用相同协议的应用程序，而网关连接的则是两个或多个使用不同协议的端点。网关扮演的是“协议转换器”的角色，即使客户端和服务器使用的是不同的协议，客户端也可以通过它完成与服务器之间的事务处理。

实际上，代理和网关之间的区别很模糊。由于浏览器和服务器实现的是不同版本的HTTP，代理也经常要做一些协议转换工作。而商业化的代理服务器也会实现网关的功能来支持SSL安全协议、SOCKS防火墙、FTP访问，以及基于Web的应用程序，比如HTTP E-mail网关。

![代理使用同一种协议，网关则将不同的协议连接起来](/book/media/http-the-definitive-guide-6-2.png)

#### 6.2 为什么使用代理

代理服务器可以改善安全性，提高性能，节省费用。代理服务器可以看到并接触到所有流过的HTTP流量，所以代理可以监视流量并对其进行修改，以实现很多有用的增值Web服务。

1. 儿童过滤器；
2. 文档访问控制，用代理服务器在大量的Web服务器和Web资源之间实现统一的访问控制策略；
3. 安全防火墙，代理服务器可以在网络中的单一安全节点上限制哪些应用层协议的数据可以流入或流出一个组织，对流量进行详细的检查，消除病毒；
4. Web缓存；
5. 反向代理（reverse proxy，或替代物，surrogate），假扮Web服务器；
6. 内容路由器，根据因特网流量状况以及内容类型将请求导向特定的Web服务器；
7. 转码器，代理服务器在将内容发送给客户端之前，修改内容的主体格式，在数据表示法之间进行透明的转换（转码，transcoding）；
8. 匿名者，主动从HTTP报文中删除身份特性（比如客户端IP地址、From首部、Referer首部、cookie、URI的会话ID），从而提供一定的私密性和匿名性。

#### 6.3 代理会去往何处

##### 6.3.1 代理服务器的部署

可以根据其目标用途，将代理放置在网络结构中的任意位置。

1. 出口代理，部署在本地网络的出口点，控制本地网络与大型因特网之间的流量，以提供针对公司外部恶意黑客的防火墙保护，降低宽带费用，提高因特网流量的性能，过滤不恰当的内容。

2. 访问（入口）代理，部署在ISP访问点，处理来自客户的聚合请求。存储常用文档的副本，提高下载速度，降低因特网带宽耗费。

3. 替代物（反向代理），部署在Web服务器之前，处理所有传送给Web服务器的请求，并只在必要时向Web服务器请求资源。用以提高Web服务器的安全性和性能，通常会直接冒用Web服务器的名字和IP地址，DNS直接解析到反向代理。

4. 网络交换代理，部署在网络之间的因特网对等交换点上，通过缓存来减轻因特网节点的拥塞，并对流量进行监视。

![可以根据其目标用途，以多种方式来部署代理](/book/media/http-the-definitive-guide-6-11.png)

##### 6.3.2 代理的层次结构

可以通过*代理层次结构（proxy hierarchy）*将代理级联起来。靠近服务器的*入口（inbound）*代理被称为父代理，靠近客户端的*出口（outbround）*代理被称为子代理。Proxy层次结构中的代理服务器被赋予了父（parent）和子（child）的关系。

代理服务器可以根据众多因素，将报文转发给一个不断变化的代理服务器和原始服务器集。常见的动态选择父代理的场景有：

1. 负载均衡；
2. 地理位置附近的路由；
3. 协议/类型路由；
4. 基于订购的路由。

##### 6.3.3 代理是如何获取流量的

有以下4种常见方式可以使客户端流量流向代理：

1. 修改客户端，在Web客户端中手工或自动配置代理；
2. 修改网络，在交换设备或路由设备中拦截网络流量并将其导入代理，称为*拦截（intercepting）*代理（也叫做“透明”代理）；
3. 修改DNS的命名空间，将IP绑定到代理上；
4. 修改Web服务器，使用HTTP重定向到代理。

#### 6.4 客户端的代理设置

现代Web浏览器都可以配置代理，一般会同时提供一下几种方式：

1. 手工配置，为代理指定主机和端口；
2. 预先配置浏览器；
3. 代理的自动配置（Proxy Auto-Configuration，PAC是一个JavaScript文件，包含一个FindProxyForURL(url, host)函数，在运行过程中计算访问URI的适当代理服务器）；
4. WPAD代理发现（Web Proxy Autodiscovery，WPAD），使用发现机制的逐级上升策略自动为浏览器查找合适的PAC文件。

#### 6.5 与代理请求有关的一些棘手问题

##### 6.5.1 代理URI与服务器URI的不同

Web服务器报文和Web代理报文的语法有一个细节点差异。  
客户端向Web服务器发送请求时，请求行中只包含部分URI（没有方案、主机和端口）；  
客户端向代理发送请求时，请求行则包含完整的URI。

在原始的HTTP设计中，客户端直接与单个服务器进行对话。不存在虚拟主机，也没有代理。单个服务器知道自己的主机名和端口，为了避免发送冗余信息，客户端只需发送部分URI即可，无需发送方案和主机（以及端口）。  
而代理需要知道目标服务器的名称，这样他们才能建立自己与服务器的连接。基于代理的网关需要知道URI的方案才能连接到FTP资源和其他方案上去。HTTP/1.0要求代理发送完整的URI，同时为服务器请求保留了部分URI的形式（HTTP/1.1要求服务器和代理都发送完整的URI）。

##### 6.5.2 于虚拟主机一样的问题

虚拟主机和代理在部分URI时所遇到问题类似，但解决方案有所差异：

1. 显式的代理要求在请求报文中使用完整的URI来解决这个问题；
2. 虚拟主机Web服务器中要求是用Host首部来承载主机和端口信息。

##### 6.5.3 拦截代理会收到部分URI

客户端的流量也可能会经过反向代理或拦截代理。在这两种情况下，客户端都会认为它在与Web服务器进行对话，不会发送完整的URI。

##### 6.5.4 代理即可以处理代理请求，也可以处理服务器请求

通用的代理服务器应该同时支持请求报文中的完整URI和部分URI。如果是显式的代理请求，代理就应该使用完整URI；如果是Web服务器请求，就应该使用部分URI和虚拟Host首部。

使用完整和部分URI的规则如下所示：

1. 如果提供的是完整URI，代理就应该使用这个完整URI；
2. 如果提供的是部分URI，而且有Host首部，就应该用Host首部来确定原始服务器的名字和端口号；
3. 如果提供的是部分URI，而且没有Host首部，用下列方法来确定原始服务器：
    1. 如果是反向代理，用真实服务器的地址和端口号来配置代理即可；
    2. 如果流量被拦截了，而且拦截者也可以提供原始的IP地址和端口，直接使用即可；
    3. 否则，返回错误报文（建议用户升级到支持Host首部的现代浏览器）。

##### 6.5.5 转发过程中对URI的修改

代理服务器转发报文时尽量不要修改URI，如果修改请求URI的话要特别小心，任何细微的修改都有可能为下游服务器带来互操作性问题，实现要尽量宽容一些，毕竟代理服务器的目标不是成为强制实现严格协议一致性的“协议警察”。

##### 6.5.6 URI的客户端自动扩展和主机名解析

如果没有找到主机，很多浏览器都会尝试着提供某种主机名自动“补充”机制，以防用户输入的是主机“简短”形式。比如很多浏览器会尝试着加入`www.`前缀。

##### 6.5.7 没有代理时URI的解析

![没有提供显式代理时，浏览器会对部分主机名进行自动扩展](/book/media/http-the-definitive-guide-6-16.png)

##### 6.5.8 有显式代理时URI的解析

![有显式代理时，浏览器不会对不完整的主机名进行自动扩展](/book/media/http-the-definitive-guide-6-17.png)

##### 6.5.9 有拦截代理时URI的解析

![使用拦截代理时，浏览器无法检测出已停用服务器的IP地址](/book/media/http-the-definitive-guide-6-17.png)

当代理最终准备好与真正的原始服务器进行交互时(5b)，代理可能会发现那个IP地址实际指向的是一个已停用的服务器。为了提供与浏览器相同级别的容错机制，代理可以通过解析Host首部的主机名，也可以通过对IP地址的反向DNS查找来尝试其他IP地址。

将浏览器配置为使用显示代理时，它们会依赖代理的容错机制，他们对拦截和显示地代理实现来说，在DNS解析到已停用的服务器时，提供容错机制是很重要的。

#### 6.6 跟踪报文

#### 6.7 代理认证

#### 6.8 代理的互操作性

#### 6.9 更多信息

## 第三部分 识别、认证与安全

## 第四部分 实体、编码和国际化

## 第五部分 内容分发与发布

## 第六部分 附录

## 附录A URI方案

## 附录B HTTP状态码

## 附录C HTTP首部参考

## 附录D MIME类型（一）

## 附录D MIME类型（二）

## 附录D MIME类型（三）

## 附录D MIME类型（四）

## 附录D MIME类型（五）

## 附录E Base-64编码

## 附录F 摘要认证

## 附录G 语言标记（一）

## 附录G 语言标记（二）

## 附录G 语言标记（三）

## 附录G 语言标记（四）

## 附录H MIME字符集注册表（一）

## 附录H MIME字符集注册表（二）

## 附录H MIME字符集注册表（三）

## 关于作者

## 尾页
