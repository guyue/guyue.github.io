---
layout: post
title: CSP简介和使用
tags: 技术 原创
---

在互联网中，网页的面临安全性问题很多，虽然HTTPS能解决大多数的问题，但HTTPS在国内环境中存在严重的劫持问题，所以在某些网络情况下还在使用HTTP协议，也就面临着：

1. JS劫持；
2. 广告注入；
3. 跨站脚本攻击（XSS）；

等等诸多问题。

**Content Security Policy**简称**CSP**，用来解决跨站脚本攻击及其类似安全问题的一组安全策略，可用来初步解决上面的问题。

CSP发展很快，自2012年[第一版](https://www.w3.org/TR/CSP1/)诞生依赖，至今[第二版](https://www.w3.org/TR/CSP2/)已经进入W3C的推荐版本，[第三版](https://www.w3.org/TR/CSP/)也处于工作草案阶段。W3C建议浏览器基于第二版规范实现，CSP在第二版中的官方定义如下：

> This document defines a policy language used to declare a set of content restrictions for a web resource, and a mechanism for transmitting the policy from a server to a client where the policy is enforced.


CSP主要有两种方式实现：
1. HTTP HEADER；
2. <meta>源；


CSP中指令的含义

| 指令名 | 规范版本 | 作用范围 |
|-------:|:--------:|----------|
| default-src | Level 1 | The default-src is the default policy for loading content such as JavaScript, Images, CSS, Font's, AJAX requests, Frames, HTML5 Media. See the Source List Reference for possible values.  |
| script-src | Level 1 | Defines valid sources of JavaScript.  |
| style-src | Level 1 | Defines valid sources of stylesheets.  |
| img-src | Level 1 | Defines valid sources of images.  |
| connect-src | Level 1 | Applies to XMLHttpRequest (AJAX), WebSocket or EventSource. If not allowed the browser emulates a 400 HTTP status code.  |
| font-src | Level 1 | Defines valid sources of fonts.  |
| object-src | Level 1 | Defines valid sources of plugins, eg &lt;object&gt;, &lt;embed&gt; or &lt;applet&gt;.  |
| media-src | Level 1 | Defines valid sources of audio and video, eg HTML5 &lt;audio&gt;, &lt;video&gt; elements.  |
| frame-src | Deprecated | Defines valid sources for loading frames. child-src is preferred over this deprecated directive.  |
| sandbox | Level 1 | Enables a sandbox for the requested resource similar to the iframe sandbox attribute. The sandbox applies a same origin policy, prevents popups, plugins and script execution is blocked. You can keep the sandbox value empty to keep all restrictions in place, or add values: allow-forms allow-same-origin allow-scripts allow-popups, allow-modals, allow-orientation-lock, allow-pointer-lock, allow-presentation, allow-popups-to-escape-sandbox, and allow-top-navigation  |
| report-uri | Level 1 | Instructs the browser to POST a reports of policy failures to this URI. You can also append -Report-Only to the HTTP header name to instruct the browser to only send reports (does not block anything).  |
| child-src | Level 2 | Defines valid sources for web workers and nested browsing contexts loaded using elements such as &lt;frame&gt; and &lt;iframe&gt;  |
| form-action | Level 2 | Defines valid sources that can be used as a HTML &lt;form&gt; action.  |
| frame-ancestors | Level 2 | Defines valid sources for embedding the resource using &lt;frame&gt; &lt;iframe&gt; &lt;object&gt; &lt;embed&gt; &lt;applet&gt;. Setting this directive to 'none' should be roughly equivalent to X-Frame-Options: DENY  |
| plugin-types | Level 2 | Defines valid MIME types for plugins invoked via &lt;object&gt; and &lt;embed&gt;. To load an &lt;applet&gt; you must specify application/x-java-applet.  |


页面在最终用户面前显示时，页面内容可能在中间的任何一个网络环节被篡改或者拦截，因此网页中的各种资源类型都需要做一定的约束。需要约束的主要资源列表如下：

1. JS文件，JS文件是浏览器中最具有表现力的文件，可以修改浏览器中渲染页面的任何元素；
2. CSS文件，CSS文件决定了浏览器外观，CSS文件的篡改可以让浏览器中的渲染的页面样子完全改变；
3. HTML文件，HTML文件可能被追加内容（最常见），当然也可以删改，甚至可能完全拦截；
4. iframe元素，iframe元素类似HTML页面中的一个沙盒，像是一个独立的世界，所以要对iframe元素的内容呈现进行约束；
5. 等等


## 参考
1. [Content Security Policy](https://content-security-policy.com/)
1. [浏览器支持情况](http://caniuse.com/#search=csp)
1. [Content Security Policy Level 2 介绍](https://imququ.com/post/content-security-policy-reference.html)
2. [Content Security Policy 介绍](https://imququ.com/post/content-security-policy-level-2.html)
