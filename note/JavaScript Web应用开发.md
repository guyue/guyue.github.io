# JavaScript Web应用开发读书笔记

## 一、构建优先

创建随时会丢掉的应用可以即兴发挥，但是开发一个可维护的应用则需要规划，要知道怎么把脑海中设想的功能组织在一起，甚至还要考虑不久之后可能会添加的功能。可维护性不是随便就能实现的，从开发应用伊始就要考虑可维护性，并在这个原则的指导下设计应用。设计应用时如果不考虑可维护性，随着功能的不断增加，应用就会像叠叠乐搭出的积木塔一样慢慢倾斜。重构就要中断产品研发，业务可经不起这样折腾。而且还要保持原有的发布周期，根本不能让积木塔倒下，所以我们只能妥协。

`构建优先原则`，在还未编写任何代码之前就做好设计，让应用的结构清晰，易于测试。构建优先原则的两个基本要素是`过程自动化`和`合理的设计`。

不增加功能的彻底重构对产品经理没有吸引力，他们的目标是提升面向客户的可视化产品，而不是底层的软件。不过你可以逐渐改进代码基，重构你接触的代码，为重构的功能编写测试，把过时的代码封装到接口中，以后再重构——这样做能不断提高项目中代码的平均质量。

构建优先原则的核心法则
1. 减少出错的可能性，因为交互过程中没有人类参与；
2. 自动执行重复性的工作，能提高工作效率；
3. 模块化、可伸缩的应用设计；
4. 能降低复杂度，让应用易于测试和维护；
5. 让发布版本符合性能方面的最佳实践；
6. 部署的代码在发布之前都经过了测试。

## 二、预处理和静态资源优化

> 速度至关重要
> 在Web中，速度是基本的决定性因素。响应速度，至少是可感知的响应速度对用户体验有重大影响。可感知的响应速度是最重要的，即使实际上完成请求要花更多的时间也没关系，只要能立即响应用户的操作，用户就会觉得你的应用运行速度很快。

1. 检查代码质量；
2. 预处理器，以提升效率、减少重复和使用更舒适的句法；
3. 打包静态资源（HTTP2中`多路复用`可以代替这个过程），减少网络请求；
4. 简化静态资源，减小文件的体积；
5. 创建子图集（HTTP2中`多路复用`可以代替这个过程，可以将强相关资源放在一起，比如mouseover之样式更换中用到的图片），减少网络请求；
6. 优化图像（无损图像压缩、有损图像压缩、隔行扫描的图像）；
7. 缓存静态资源（Expires首部，Last-Modified + Cache-Control: public, max-age 或 ETag + Cache-Control: public, max-age）（max-age在Cache-Control首部中，另其public代表允许网路中中间代理设备缓存，private则只允许客户端缓存）;
8. 内嵌对首屏至关重要的CSS，避免无样式内容闪烁（Flash of Unstyled Content，简称FOUC）。

## 三、精通环境配置和开发流程

一个完整的构建模式配置，能满足以下三个环境：
1. 本地开发环境：用于日常开发应用，使用调试模式构建以便于调试、堆栈跟踪和诊断问题，快速开发；
2. 过渡环境：也叫做测试环境，专门用于确保部署到生产环境之后不会出现问题；
3. 生产环境：用户访问的环境，用发布模式构建，优化应用的性能。

> 环境层面的配置是指一下这些类型的值：
> 1. 数据库连接字符串；
> 2. API认证凭证；
> 3. 会话加密密令；
> 4. 监听HTTP请求的Web服务器端口；
> 
> 经验法则：像开发开源软件那样开发你的应用。

## 四、发布、部署和监控
持续集成（Continuous Integration，简称CI）平台的作用是在主机环境中确保测试都能通过，把更稳定的版本部署到生产环境。

准备发布应用时，要使用一些Web最佳实践；

部署应用前，要测试发布版本：
1. 单元测试：把应用中的各组件隔离开单独测试，确保组件各自能单独运行；
2. 集成测试：也叫做端到端测试，测试已经进行过单元测试的多个组件之间的交互，确保多个组件之间能恰当的交互。

预部署操作
1. 语义话版本：为版本指定有意义的版本号；
2. 更改日志：更改日志列出的是开发历史过程中的各项改动。

持续集成
持续集成是一种软件开发实践。在这个实践中，团队成员频繁的进行集成，每次集成后都会通过自动化构建（包括测试）来尽快发现集成过程中的错误。用这种方法能快速开发中衔接行很好的软件。

监控和诊断
监控是指保存访问日志（谁访问了什么，什么时候访问，从哪里来）和错误日志（什么出错了），以及设置报警系统——最重要，以便出现预期中的错误时及时收到通知，时刻准备好去处理问题。

## 五、理解模块化和依赖管理

### 封装代码
封装是为了让功能自成一体，隐藏实现细节，不让使用代码的人看到。任何代码，不管是一个函数还是整个模块，都应该明确定义自己的职责，隐藏实现细节，提供简明的API以满足使用者的需求。功能自成一体的代码要比有多个职责的代码更易于理解和修改。

1. 理解单一职责原则
单一职责原则（Single Responsibility Principle，简称SRP）：只让包做一件事，并把它做好。
保持代码简明扼要，而且实现的功能完全和函数名一致，是可维护、可测试代码的基本要素。

2. 信息隐藏和接口
有一种方法能逐渐降低复杂度，即隐藏不必要的信息，不在接口中开放。

> 纯函数
> 其返回结果只取决于传入的参数，与不在参数中的状态变量、服务活对象都没有关系。切除了返回值之外没有任何副作用。

3. 作用域和`this`关键字
在任何JavaScript代码中，上下文都由当前函数的作用域和`this`组成。在JavaScript中，用`var`定义的变量作用域位于函数层面（词法作用域），而不是代码块层面。
默认情况下，`this`关键字引用的是全局变量。在严格模式中，`this`的默认值是undefined，而不是window。
如果没有使用严格模式，`this`引用的始终是一个对象：如果调用者是对象引用，则`this`引用的是这个对象；如果调用者是基本类型的值，例如布尔值、字符串或数值，则`this`引用的是这些值对应的包装对象；如果调用者是`undefined`或`null`，抑或直接调用方法，或者调用`.call`、`.apply`或`.bind`方法，那么`this`引用的是全局变量（严格模式下引用的是undefined）。在严格模式中，通过`this`向函数传值时，`this`引用不会打包成对象。

在JavaScript中，变量的作用域按下述顺序确定：
1. 作用域的上下文变量：this和arguments（当变量名是this或arguments时，则指this和arguments）；
2. 函数的具名参数；
3. 函数表达式；
4. 本地作用域中的变量；

4. 严格模式
在文件或函数的顶部加入`'use strict'`即可。
严格模式中，禁用with语句和八进制计数法、禁用eval和arguments关键字。下列操作会抛出错误：
    1. 为只读属性赋值；
    2. 删除不能删除的属性；
    3. 使用重复的属性键实例化对象；
    4. 使用重复的参数名声明函数。

5. 变量的作用域提升
在JavaScript中，作用域提升的意思是，声明的变量会移到作用域的开头。对于函数声明来说，提升的是整个表达式。

### JavaScript模块
函数也叫闭包，这是为了强调函数会创建新的作用域。

如果组件相互依赖，那就代表代码异味（code smell），可能暗示着代码有深层次的问题，处理依赖最好的方式是：彻底避免依赖。

## 六、理解JavaScript中的异步流控制方法
1. 使用回调（为匿名函数命名；去掉不必要的回调；在流程控制调码中使用条件语句要小心）；
2. 使用async库（并行、串行、瀑布式）；
3. 使用Promise对象（Promise对象处于pending、fulfilled和rejected三种状态之一）；
4. 理解事件，使用订阅发布模式；
5. ES6生成器（Todo：需仔细学习）。

## 七、使用MVC模式
MVC模式通过分离关注点来提升软件的质量。MVC把关注点分离成三种模块：模型、视图和控制器。这三部分相互联系，把信息的内部表示（即模型，使用开发者理解的方式表示数据）、表现层（即视图，用来把数据展现给用户）和逻辑（即控制器，用来连接这两种表示相同数据的不同方式，还会验证用户输入的数据，决定把那个试图展现给用户）分开。各部分之间相互作用、相互合作，组成一个完整的应用。使用MVC，大部分逻辑都自成一体，也就是说，复杂的视图不会把应用变复杂，因此MVC特别适合开发可伸缩的应用。

### 模型
定义视图要传达的信息。

### 视图
视图用于定义组件的外观，说明如何在界面中显示组件，以及在什么地方显示数据。一般使用模板引擎来简化代码编写，把模板字符串和数据提供给模板引擎，让引擎用数据填充模板。

### 控制器
控制器决定要渲染的视图，并提供相关的模型以供渲染。并添加DOM事件等其他行为，响应特定的操作，或者重定向到其他视图。

### 路由
路由使用预先定义好的规则，把URL模式匹配到控制器的动作上。路由把工作委托给控制器完成，在控制器中会验证请求，判断是要渲染视图、重定向到其他URL还是执行其他类似的操作。

> 渐进增强的目的是：为每个访问网站的人提供属实的体验。
> 服务器端渲染可以提升可感知的性能。首次加载的效果非常重要，较之等待Backbone读取数据、填充视图再渲染模板，在用户没有看到任何内容之前先在服务器中渲染应用更好。

## 八、测试JavaScript组件
测试能增强我们编写的模块和应用的可靠性，还能确保模块和应用能按预期的方式工作。

测试的精髓在于学会如何隔离功能，让功能易于测试。这就是模块化对于可测试的代码如此重要的原因。代码易于测试了，质量就上去了——代码质量是构建优先原则的基石。
耦合松散的模块化代码更易于测试，因为要考虑的事情更少，测试更细化，只需要关注一小部分代码的功能是否正常即可。与此相反，耦合紧密的整体式代码更难测试，因为可能出错的地方更多，而且有些可能和你想要测试的功能完全无关。

单元测试：隔离确认小型组件的功能时无需关注依赖，此时能最大限度的发挥测试的功效。好的单元测试不关注组件的实现细节，只关注组件的公开API。
集成测试：用于测试组件之间是否能按预期交互，关注的是多个组件相互配合实现的功能。
外观测试：在不同尺寸的视区中截图应用的界面，以验证布局没变混乱。可以通过工具对比截图和预期效果图的差异。
性能测试：密切关注应用的性能有利于快速找出性能问题的根本原因。可以使用Google PageSpeed后Yahoo YSlow等工具监控Web的性能。

## 九、REST API设计和分层服务

### 规避API设计误区
常见API设计的问题
1. 不同的请求使用不同的命名约定；
2. 没有区分渲染视图端点和API端点；
3. 没有明确区分查询参数和请求主题；
4. HTTP方法使用不合适；
5. API不一致。

### 学习REST API设计
REST是Representational State Transfer（表现层状态转化）的简称，是一套全面的API设计指导方针。用于约束和辅助开发通过HTTP使用的API。

设计API最重要的一点是保持一致行，而且从端点的名称开始就要使用一致的命名约定方式。命名可以参考以下原则：
1. 所有API端点都要有一个前缀，或者单独的二级域名；
2. 全部小写，使用连字符；
3. 使用一个或两个名次描述资源；
4. 资源一定要使用复数；

| 方法 | 端点 | 说明 |
|-----|-----|-----|
| GET | /products | 获取一系列商品 |
| GET | /products/:id | 通过ID获取单个商品 |
| GET | /products/:id/parts | 获取单个商品的各个部件 |
| PUT | /products/:id/parts | 为某个商品添加一个新部件 |
| DELETE | /products/:id | 删除指定ID对应的商品 |
| PUT | /products | 添加一个新商品 |
| HEAD | /products/:id | 通过状态码判断商品是否存在 |
| PATCH | /products/:id | 编辑指定ID对应的现有商品 |
| POST | /authentication/login | 多数其他站点应该使用POST方法 |

API的版本应该在HTTP首部中设定，如果请求中没有指定版本，应该使用最新版的API响应。

使用统一格式的消息容器对返回数据进行封装， 一般包含data，error等属性。

状态码特别重要，因为API的使用者可以根据状态码预测响应。

分页响应（添加Link首部，使用rel表示链接的角色）。如果数据流动太快，则可以不适用页数，使用标识符或令牌记录上次到达的位置，生成下一页。

缓存响应，提高响应速度。

请求限流，也叫做频率限制，用于限制一段时间内客户端能请求API的次数。

任何值的使用的API，不管是否面向公众，都要有完好的文档。好的API文档应该满足下面几点要求：
1. 说明响应的消息容器是什么样子；
2. 演示报告错误的方式；
3. 概述认证、分页、限流和缓存的工作方式；
4. 详细说明每个端点、查询这些端点要使用的HTTP方法、请求中应该包含的每个数据，以及可能出现在响应中的各个字段。










